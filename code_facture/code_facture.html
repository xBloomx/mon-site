<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Facturation F.Dussault</title>
    <style>
        /* =========================================
           1. VARIABLES & LAYOUT G√âN√âRAL
           ========================================= */
        :root { 
            --app-bg: #1e1f26;
            --btn-yellow: #fcca46; 
            --blue-bg: #d1e9ff; 
            --btn-green: #28a745;
            --btn-grey: #343a40;
            --btn-red: #ff4d4d;
            --text-light: #e0e0e0;
            --card-bg: #2b2c36;
        }
        
        * { box-sizing: border-box; }

        body { 
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--app-bg); 
            color: var(--text-light);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* ZONE PRINCIPALE */
        .main-content {
            flex: 1;
            display: flex; flex-direction: column;
            position: relative; background-color: var(--app-bg);
            overflow: hidden;
        }

        /* =========================================
           2. VUE TABLEAU DE BORD (DASHBOARD)
           ========================================= */
        #view-dashboard {
            padding: 30px;
            height: 100%;
            overflow-y: auto;
            display: flex; 
            flex-direction: column;
            gap: 20px;
        }

        .dash-header { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; 
        }
        .dash-title h1 { margin: 0; font-size: 28px; color: white; }
        .dash-title p { margin: 5px 0 0; color: #aaa; font-size: 14px; }

        .toolbar {
            display: flex; gap: 15px; align-items: center;
            background-color: transparent; padding: 0; margin-bottom: 10px;
        }
        .search-box { flex: 1; position: relative; display: flex; align-items: center; }
        .search-box input {
            width: 100%; background: var(--card-bg); border: 1px solid #444;
            color: white; padding: 12px 15px 12px 40px; border-radius: 8px;
            font-size: 16px; outline: none;
        }
        .search-icon { position: absolute; left: 12px; color: #888; pointer-events: none; }
        .filter-select {
            background: var(--card-bg); color: white; border: 1px solid #444;
            padding: 12px; border-radius: 8px; font-size: 16px; outline: none; cursor: pointer;
        }

        .invoice-list { display: flex; flex-direction: column; gap: 15px; }
        .invoice-item {
            background-color: var(--card-bg);
            padding: 20px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            transition: transform 0.2s ease, background-color 0.2s; cursor: pointer;
            border-left: 5px solid transparent;
        }
        .invoice-item:hover { transform: translateY(-3px); background-color: #343542; border-left: 5px solid var(--btn-yellow); }
        .inv-info { display: flex; gap: 20px; align-items: center; flex: 1; }
        .inv-id { font-weight: bold; font-size: 18px; color: var(--btn-yellow); width: 80px; }
        .inv-client { font-weight: bold; font-size: 16px; color: white; flex: 1; }
        .inv-date { color: #aaa; font-size: 14px; width: 100px; text-align: right; }
        
        .inv-actions { display: flex; gap: 10px; margin-left: 20px;}
        .btn-icon { background: #444; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; }
        .btn-icon:hover { background: #555; }
        .btn-delete { background: rgba(220, 53, 69, 0.2); color: var(--btn-red); }
        .btn-delete:hover { background: var(--btn-red); color: white; }

        /* =========================================
           3. VUE √âDITEUR (FACTURE)
           ========================================= */
        #view-editor { display: none; flex-direction: column; height: 100%; }

        /* üî• DESIGN DU RUBAN HARMONIS√â üî• */
        .top-bar {
            height: 80px; display: flex; align-items: center; justify-content: center; gap: 15px; padding: 0 20px;
            background: rgba(30, 31, 38, 0.95); border-bottom: 1px solid #333; z-index: 101; 
            flex-wrap: wrap; 
        }
        
        .action-btn {
            background-color: var(--btn-yellow); color: black; border: none;
            padding: 10px 20px; border-radius: 50px; font-weight: bold; font-size: 12px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; align-items: center; gap: 8px; white-space: nowrap; transition: transform 0.2s;
        }
        .action-btn:hover { background-color: #ffd66b; transform: translateY(-1px); }

        .btn-back { background-color: var(--btn-grey) !important; color: white !important; }
        .btn-back:hover { background-color: #23272b !important; }
        .btn-save { background-color: var(--btn-green) !important; color: white !important; }
        .btn-save:hover { background-color: #218838 !important; }
        
        .scroll-area { flex: 1; overflow: auto; padding: 20px; display: flex; justify-content: center; touch-action: pan-x pan-y; }

        /* =========================================
           4. STYLE PAPIER / FACTURE
           ========================================= */
        .page { 
            width: 8.5in; height: 11in; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            box-sizing: border-box; display: flex; flex-direction: column; position: relative; margin-bottom: 20px;
            color: black; padding: 0.25in;
        }
        input { outline: none; border-radius: 0; }
        input:focus { background-color: transparent !important; border-bottom: 2px solid #000 !important; }

        #invoice-container { display: flex; flex-direction: column; gap: 20px; transform-origin: top center; transition: transform 0.1s ease-out; padding-bottom: 100px; }
        .page.invoice-style { padding: 0.25in; }

        .top-section { width: 100%; }
        
        /* HEADER EPUR√â (Plus de texte HTML parasite) */
        .header-main { width: 100%; margin-bottom: 15px; text-align: left; }
        .header-main img { max-width: 100%; height: auto; display: inline-block; }

        .info-section { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 2px; }
        .info-column { display: flex; flex-direction: column; gap: 1px; }
        .field { display: flex; align-items: flex-end; font-size: 12px; font-weight: bold; min-height: 22px; }
        .field label { white-space: nowrap; margin-right: 5px; }
        .field input { background-color: var(--blue-bg) !important; border: none; border-bottom: 1px solid black; flex-grow: 1; height: 18px; padding: 0 5px; color: black; font-weight: bold;}

        .banner-cmmtq { width: 100%; margin: 7px 0 5px 0; text-align: center; }
        .banner-cmmtq img { width: 100%; height: auto; display: block; margin: 0 auto; }

        .main-table { width: 100%; border-collapse: collapse; border: none; margin-bottom: 10px; } 
        .main-table thead { border-top: 4px double black; }
        .main-table th { border: 1px solid black; font-size: 9px; background: #eee; padding: 2px; color: black;}
        .main-table td { border: 1px solid black; height: 24px; background-color: var(--blue-bg); padding: 0; }
        .main-table tbody tr:last-child td { border-bottom: 4px double black; }
        .main-table input { width: 100%; height: 100%; background: transparent; border: none; padding: 0 5px; box-sizing: border-box; font-size: 12px; color: black; font-weight: bold;}

        .bottom-section { margin-top: auto; width: 100%; }

        .time-wrapper { width: 100%; border: 1px solid black; border-collapse: collapse; table-layout: fixed; margin-top: 0; }
        .time-label-col { width: 110px; border-right: 1px solid black; padding: 5px; vertical-align: top; }
        .time-label-col span { font-size: 8px; font-weight: bold; color: black;}
        .time-label-col h2 { font-size: 18px; margin: 5px 0 0 0; font-weight: 900; color: black;}

        .inner-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .row-headers td { border-right: 1px solid black; border-bottom: 1px solid black; height: 30px; font-size: 8px; font-weight: bold; text-align: center; vertical-align: top; padding-top: 2px; color: black;}
        .row-sublabels td { font-size: 9px; font-weight: bold; text-align: center; padding: 2px 0; border-right: none; color: black;}
        .row-inputs td { padding: 2px 5px; vertical-align: middle; border-right: none; height: 26px; }
        .input-box { background-color: var(--blue-bg); border-bottom: 1px solid black; display: flex; align-items: center; padding: 0 3px; height: 18px; }
        .input-box input { background: transparent; border: none; width: 100%; height: 100%; text-align: center; font-size: 11px; font-weight: bold; color: black;}
        .flex-group { display: flex; align-items: center; gap: 4px; font-size: 9px; font-weight: bold; color: black;}
        .last-col { border-right: none !important; }

        .footer-grid { display: grid; grid-template-columns: 1fr 1fr 150px; align-items: end; margin-top: 5px; gap: 10px; }
        .sig-box { width: 100%; text-align: center; }
        .display-sig { border: none; border-bottom: 1px solid #000; background-color: var(--blue-bg); width: 100%; height: 50px; cursor: pointer; object-fit: contain; }
        .sig-text { font-size: 10px; font-weight: bold; margin-top: 2px; color: black;}

        .invoice-num-box { text-align: right; padding-bottom: 5px; display: flex; justify-content: flex-end; align-items: flex-end; }
        .red-invoice-input { color: #dc3545; font-weight: bold; font-size: 18px; font-family: 'Courier New', Courier, monospace; text-align: right; border: none; background-color: var(--blue-bg); width: 100%; margin: 0; padding: 0 5px; }
        .red-invoice-input::placeholder { color: #ffcccc; font-size: 12px; }

        /* MODAL & ZOOM */
        #sig-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; }
        .modal-content { background: white; padding: 15px; border-radius: 8px; text-align: center; width: 90%; max-width: 800px; }
        #modal-canvas { border: 2px dashed #444; background: #fff; width: 100%; height: 350px; touch-action: none; }
        .modal-btns { margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .btn-ok { background: var(--btn-green); padding: 12px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer;}
        .btn-clear { background: var(--btn-yellow); color: black; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;}
        .btn-cancel { background: var(--btn-red); padding: 12px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer;}

        .zoom-controls { position: fixed; bottom: 20px; right: 20px; background: rgba(30, 31, 38, 0.95); padding: 5px 10px; border-radius: 50px; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 2000; border: 1px solid #555; }
        .zoom-controls button { background: var(--btn-yellow); border: none; width: 32px; height: 32px; border-radius: 50%; font-weight: bold; font-size: 18px; cursor: pointer; display: flex; justify-content: center; align-items: center; color: #1e1f26; }
        .zoom-controls button:active { transform: scale(0.9); }
        .zoom-controls span { color: white; font-size: 12px; font-weight: bold; min-width: 45px; text-align: center; }

        /* MODALES CUSTOM */
        .custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); display: none; z-index: 4000; justify-content: center; align-items: center; }
        .custom-modal-card { background: var(--card-bg); width: 350px; padding: 25px; border-radius: 12px; border: 1px solid #555; box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center; }
        .custom-modal-title { font-size: 20px; color: var(--btn-red); margin-bottom: 15px; font-weight: bold; }
        .custom-modal-msg { color: var(--text-light); margin-bottom: 25px; font-size: 15px; line-height: 1.4; }
        .custom-modal-actions { display: flex; justify-content: center; gap: 10px; }
        .btn-modal-cancel { background: #444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-modal-confirm { background: var(--btn-red); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-modal-ok { background: var(--btn-yellow); color: black; border: none; padding: 10px 30px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* =========================================
           5. ADAPTATION TABLETTE & MOBILE
           ========================================= */
        @media (max-width: 1024px) {
            .top-bar { 
                padding: 10px 70px 10px 10px; gap: 10px; height: 65px; 
                overflow-x: auto; justify-content: flex-start; flex-wrap: nowrap; 
                -webkit-overflow-scrolling: touch; 
            }
            .top-bar::-webkit-scrollbar { display: none; }
            .top-bar .action-btn, .spacer-mobile { flex-shrink: 0; width: auto; margin-bottom: 0; }
            .top-bar .action-btn { font-size: 11px; padding: 8px 15px; }
        }

        @media (max-width: 768px) {
            #view-dashboard { padding: 15px; }
            .dash-header { flex-direction: column; align-items: flex-start; gap: 15px; padding-right: 60px; }
            .dash-header .action-btn { width: 100%; justify-content: center; padding: 15px; font-size: 14px; }
            .toolbar { flex-direction: column; gap: 10px; width: 100%; }
            .search-box, .search-box input, .filter-select { width: 100%; }
            .invoice-item { flex-direction: column; align-items: flex-start; gap: 15px; }
            .inv-info { flex-direction: column; align-items: flex-start; gap: 5px; width: 100%; }
            .inv-id { width: auto; font-size: 16px; } 
            .inv-client { opacity: 0.9; font-size: 18px; }
            .inv-date { text-align: left; width: auto; font-size: 13px; }
            .inv-actions { align-self: flex-end; margin-left: 0; margin-top: -35px; }
            
            /* D√âSACTIVATION DES BOUTONS DE ZOOM SUR MOBILE (Pincement conserv√©) */
            .zoom-controls { display: none !important; }
            .scroll-area { padding: 10px; }
        }

        /* IMPRESSION */
        @media print {
            @page { margin: 0; size: letter; }
            html, body { margin: 0 !important; padding: 0 !important; height: 100% !important; width: 100% !important; background: white !important; }
            .sidebar, .top-bar, #sig-modal, .zoom-controls, #view-dashboard, .custom-modal-overlay { display: none !important; }
            #view-editor { display: flex !important; width: 100% !important; height: 100% !important; }
            .scroll-area { overflow: visible !important; padding: 0 !important; height: 100% !important; display: block !important; }
            #invoice-container { margin: 0 !important; padding: 0 !important; transform: none !important; width: 100% !important; }
            .page { box-shadow: none !important; margin: 0 !important; width: 100% !important; height: 11in !important; page-break-after: always !important; padding: 0.25in !important; display: flex !important; flex-direction: column !important; }
            .field input, .main-table td, .display-sig, .input-box, .red-invoice-input { background-color: transparent !important; }
        }
    </style>
</head>
<body>

<div class="main-content">
    <div id="view-dashboard">
        <div class="dash-header">
            <div class="dash-title"><h1>Mes Factures</h1><p>G√©rez votre historique et cr√©ez de nouvelles factures</p></div>
            <button class="action-btn" onclick="openNewInvoice()"><span>+</span> Nouvelle Facture</button>
        </div>
        <div class="toolbar">
            <div class="search-box"><span class="search-icon">üîç</span><input type="text" id="searchInput" placeholder="Rechercher (Client, N¬∞...)" onkeyup="filterInvoices()"></div>
            <select class="filter-select" id="clientFilter" onchange="filterInvoices()"><option value="all">Tous les clients</option></select>
        </div>
        <div class="invoice-list" id="invoiceListContainer"></div>
    </div>

    <div id="view-editor">
        <div class="top-bar">
            <button class="action-btn btn-back" onclick="askGoBack()">‚¨Ö Retour</button>
            <button class="action-btn btn-save" onclick="saveCurrentInvoice()">üíæ SAUVEGARDER</button>

            <div style="flex:1" class="spacer-mobile"></div>
            
            <button class="action-btn" onclick="window.print()">üñ®Ô∏è Imprimer</button>
            <button class="action-btn" onclick="addPage()">‚ûï Page</button>
            <button class="action-btn" onclick="duplicatePage()">üìÑ Dupliquer</button>
            <button class="action-btn" onclick="deletePage()">‚ûñ Page</button>
            <button class="action-btn" onclick="askClearInputs()">üßπ Effacer</button>
        </div>
  
        <div class="scroll-area"><div id="invoice-container"></div></div>
        
        <div class="zoom-controls">
            <button onclick="adjustZoom(-0.1)">‚àí</button><span id="zoom-level">100%</span><button onclick="adjustZoom(0.1)">+</button><button onclick="resetZoom()" style="font-size: 14px;">‚Ü∫</button>
        </div>
    </div>
</div>

<div id="sig-modal">
    <div class="modal-content">
        <h3 style="margin-top:0">Signez ici</h3>
        <canvas id="modal-canvas"></canvas>
        <div class="modal-btns">
            <button class="btn-cancel" onclick="closeModal()">ANNULER</button>
            <button class="btn-clear" onclick="clearModalCanvas()">EFFACER</button>
            <button class="btn-ok" onclick="saveSignature()">OK</button>
        </div>
    </div>
</div>

<div class="custom-modal-overlay" id="confirmModal">
    <div class="custom-modal-card">
        <div class="custom-modal-title">Confirmation</div>
        <div class="custom-modal-msg" id="confirmMsg">...</div>
        <div class="custom-modal-actions">
            <button class="btn-modal-cancel" onclick="closeConfirmModal()">Non</button>
            <button class="btn-modal-confirm" id="confirmYesBtn">Oui</button>
        </div>
    </div>
</div>

<div class="custom-modal-overlay" id="alertModal">
    <div class="custom-modal-card">
        <div class="custom-modal-title" style="color:var(--btn-yellow);">Information</div>
        <div class="custom-modal-msg" id="alertMsg">...</div>
        <div class="custom-modal-actions">
            <button class="btn-modal-ok" onclick="closeAlertModal()">Compris</button>
        </div>
    </div>
</div>

<script>
    let invoicesData = [];
    const STORAGE_KEY = 'dussault_invoices_v1';
    let currentInvoiceId = null;

    // --- GESTION DES MODALES ---
    let confirmCallback = null;

    function showConfirm(msg, callback) {
        document.getElementById('confirmMsg').textContent = msg;
        confirmCallback = callback;
        document.getElementById('confirmModal').style.display = 'flex';
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
        confirmCallback = null;
    }

    document.getElementById('confirmYesBtn').onclick = function() {
        if (confirmCallback) confirmCallback();
        closeConfirmModal();
    };

    function showAlert(msg) {
        document.getElementById('alertMsg').textContent = msg;
        document.getElementById('alertModal').style.display = 'flex';
    }

    function closeAlertModal() {
        document.getElementById('alertModal').style.display = 'none';
    }

    // --- APP LOGIC ---

    function loadData() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            invoicesData = JSON.parse(stored);
        } else {
            invoicesData = [];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(invoicesData));
        }
        updateClientFilter();
        renderInvoiceList(invoicesData);
    }
    
    function saveData() { 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(invoicesData)); 
        updateClientFilter(); 
        renderInvoiceList(invoicesData); 
    }

    const viewDashboard = document.getElementById('view-dashboard');
    const viewEditor = document.getElementById('view-editor');
    const listContainer = document.getElementById('invoiceListContainer');
    const containerInvoice = document.getElementById('invoice-container');

    function showDashboard() { 
        viewDashboard.style.display = 'flex'; 
        viewEditor.style.display = 'none'; 
        renderInvoiceList(invoicesData); 
    }
    
    function askGoBack() {
        showConfirm("Voulez-vous retourner au menu ? Assurez-vous d'avoir sauvegard√©.", function() {
            showDashboard();
        });
    }

    function openExistingInvoice(id) {
        const invoice = invoicesData.find(inv => inv.id === id);
        if (!invoice) return;
        currentInvoiceId = id;
        viewDashboard.style.display = 'none';
        viewEditor.style.display = 'flex';
        containerInvoice.innerHTML = '';
        const pageCount = invoice.pageCount || 1;
        for(let i=0; i<pageCount; i++) containerInvoice.appendChild(createInvoicePageHTML());
        
        const allInputs = containerInvoice.querySelectorAll('input');
        if (invoice.inputValues) {
            allInputs.forEach((input, index) => { 
                if (invoice.inputValues[index] !== undefined) input.value = invoice.inputValues[index]; 
            });
        }
        
        const allSigs = containerInvoice.querySelectorAll('.display-sig');
        if (invoice.sigValues) {
            allSigs.forEach((img, index) => { 
                if (invoice.sigValues[index]) img.src = invoice.sigValues[index]; 
            });
        }
        resetZoom();
    }

    function getNextInvoiceNumber() {
        let maxId = 0;
        invoicesData.forEach(inv => {
            const num = parseInt(inv.id);
            if(!isNaN(num) && num > maxId) {
                maxId = num;
            }
        });
        return maxId > 0 ? maxId + 1 : 1000;
    }

    function openNewInvoice() {
        currentInvoiceId = null;
        viewDashboard.style.display = 'none';
        viewEditor.style.display = 'flex';
        containerInvoice.innerHTML = '';
        containerInvoice.appendChild(createInvoicePageHTML());
        
        const nextNum = getNextInvoiceNumber();
        const numInput = containerInvoice.querySelector('.red-invoice-input');
        if(numInput) numInput.value = nextNum;
        
        resetZoom();
    }

    function saveCurrentInvoice() {
        const firstPage = containerInvoice.querySelector('.page');
        if (!firstPage) return;
        
        const inputs = firstPage.querySelectorAll('.top-section input');
        const clientName = inputs[0] ? inputs[0].value.trim() : "Client Inconnu";
        const dateVal = inputs[4] ? inputs[4].value.trim() : new Date().toISOString().split('T')[0];
        
        const invoiceNumInput = firstPage.querySelector('.red-invoice-input');
        let invoiceNum = (invoiceNumInput && invoiceNumInput.value.trim() !== '') ? invoiceNumInput.value.trim() : "Brouillon-" + Date.now().toString().slice(-4);

        const inputValues = Array.from(containerInvoice.querySelectorAll('input')).map(input => input.value);
        const sigValues = Array.from(containerInvoice.querySelectorAll('.display-sig')).map(img => img.getAttribute('src'));
        const pageCount = containerInvoice.querySelectorAll('.page').length;
        
        const newInvoiceObj = { 
            id: invoiceNum, 
            client: clientName || "Client Inconnu", 
            date: dateVal, 
            inputValues: inputValues, 
            sigValues: sigValues, 
            pageCount: pageCount, 
            timestamp: Date.now() 
        };
        
        if (currentInvoiceId) {
            const index = invoicesData.findIndex(inv => inv.id === currentInvoiceId);
            if (index !== -1) {
                if (currentInvoiceId !== invoiceNum) {
                    const exists = invoicesData.find(inv => inv.id === invoiceNum);
                    if (exists) { 
                        invoicesData.splice(index, 1); 
                        invoicesData.push(newInvoiceObj); 
                    } else {
                        invoicesData[index] = newInvoiceObj;
                    }
                } else {
                    invoicesData[index] = newInvoiceObj;
                }
            } else {
                invoicesData.push(newInvoiceObj);
            }
        } else {
            const exists = invoicesData.find(inv => inv.id === invoiceNum);
            if (exists && invoiceNum.startsWith('Brouillon-')) {
                 const index = invoicesData.findIndex(inv => inv.id === invoiceNum);
                 invoicesData[index] = newInvoiceObj;
            } else {
                 invoicesData.push(newInvoiceObj);
            }
        }
        
        currentInvoiceId = invoiceNum;
        saveData();
        showAlert("Facture sauvegard√©e avec succ√®s !");
    }

    function deleteInvoice(id, event) {
        event.stopPropagation();
        showConfirm("Voulez-vous vraiment supprimer la facture #" + id + " ?", function() {
            invoicesData = invoicesData.filter(inv => inv.id !== id);
            saveData();
        });
    }

    function renderInvoiceList(data) {
        listContainer.innerHTML = '';
        const sortedData = [...data].sort((a, b) => b.timestamp - a.timestamp);
        
        if(sortedData.length === 0) { 
            listContainer.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">Aucune facture.</div>';
            return; 
        }
        
        sortedData.forEach(inv => {
            const item = document.createElement('div');
            item.className = 'invoice-item';
            item.onclick = function() { openExistingInvoice(inv.id); };
            item.innerHTML = `
                <div class="inv-info">
                    <div class="inv-id">#${inv.id}</div>
                    <div class="inv-client">${inv.client}</div>
                    <div class="inv-date">${inv.date}</div>
                </div>
                <div class="inv-actions">
                    <button class="btn-icon btn-delete" onclick="deleteInvoice('${inv.id}', event)" title="Supprimer">üóëÔ∏è</button>
                </div>`;
            listContainer.appendChild(item);
         });
    }

    function updateClientFilter() {
        const select = document.getElementById('clientFilter');
        select.innerHTML = '<option value="all">Tous les clients</option>';
        [...new Set(invoicesData.map(inv => inv.client))].sort().forEach(client => {
            if(client && client !== "Client Inconnu") { 
                const opt = document.createElement('option'); 
                opt.value = client; 
                opt.textContent = client; 
                select.appendChild(opt); 
            }
        });
    }

    function filterInvoices() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const clientFilter = document.getElementById('clientFilter').value;
        const filtered = invoicesData.filter(inv => {
            return (inv.client.toLowerCase().includes(searchText) || String(inv.id).toLowerCase().includes(searchText)) && 
                   (clientFilter === 'all' || inv.client === clientFilter);
        });
        renderInvoiceList(filtered);
    }

    const inputAttrs = `type="text" autocomplete="off" autocorrect="off" autocapitalize="sentences" spellcheck="false"`;
    let invoicePageCount = 0;
    let globalSigCount = 0;

    function createInvoicePageHTML() {
        invoicePageCount++;
        globalSigCount++;
        const page = document.createElement('div');
        page.className = 'page invoice-style';
        
        let rows = "";
        for(let i=0; i<20; i++) { 
            rows += `<tr><td><input ${inputAttrs}></td><td><input ${inputAttrs}></td><td><input ${inputAttrs}></td><td><input ${inputAttrs}></td></tr>`;
        }

        page.innerHTML = `
            <div class="top-section">
                <div class="header-main">
                    <img src="logo_dussault.png" alt="F. Dussault">
                </div>
                
                <div class="info-section">
                    <div class="info-column">
                        <div class="field"><label>M.</label><input ${inputAttrs}></div>
                        <div class="field"><input ${inputAttrs}></div>
                        <div class="field" style="margin-top:2px;"><label>Po client:</label><input ${inputAttrs}></div>
                        <div class="field"><label>T√©l:</label><input ${inputAttrs}></div>
                    </div>
                    <div class="info-column">
                        <div class="field"><label>Date:</label><input ${inputAttrs}></div>
                        <div class="field"><label>Travail √†:</label><input ${inputAttrs}></div>
                        <div class="field"><label>Adresse:</label><input ${inputAttrs}></div>
                        <div class="field"><label>Po:</label><input ${inputAttrs}></div>
                    </div>
                </div>
                <div class="banner-cmmtq"><img src="cmmtq_et_slogan.png" alt="CMMTQ"></div>
            </div>
            
            <table class="main-table">
                <thead>
                    <tr><th width="45">QUANT.</th><th>DESCRIPTION</th><th width="75">MONTANT<br>AMOUNT</th><th width="75">TOTAL</th></tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
            
            <div class="bottom-section">
                <table class="time-wrapper">
                    <tr>
                        <td class="time-label-col"><span>1 1/2% apr√®s 30 jours<br>after 30 days</span><h2># TEMPS</h2></td>
                        <td>
                            <table class="inner-table">
                                <tr class="row-headers"><td style="width:25%">TARIF PAR HRE</td><td style="width:15%">CHARGE MIN.</td><td style="width:25%">TRANSPORT</td><td style="width:20%">HRE ARRIV√âE</td><td class="last-col" style="width:15%">INITIALE</td></tr>
                                <tr class="row-sublabels"><td>A.M.</td><td>INITIALE</td><td>P.M.</td><td></td><td class="last-col">INITIALE</td></tr>
                                <tr class="row-inputs"><td><div class="flex-group">DE <div class="input-box"><input ${inputAttrs}></div> √Ä <div class="input-box"><input ${inputAttrs}></div></div></td><td><div class="input-box"><input ${inputAttrs}></div></td><td><div class="flex-group">DE <div class="input-box"><input ${inputAttrs}></div> √Ä <div class="input-box"><input ${inputAttrs}></div></div></td><td><div class="flex-group">TOTAL <div class="input-box"><input ${inputAttrs}></div></div></td><td class="last-col"><div class="input-box"><input ${inputAttrs}></div></td></tr>
                                <tr class="row-inputs"><td><div class="flex-group">DE <div class="input-box"><input ${inputAttrs}></div> √Ä <div class="input-box"><input ${inputAttrs}></div></div></td><td><div class="input-box"><input ${inputAttrs}></div></td><td><div class="flex-group">DE <div class="input-box"><input ${inputAttrs}></div> √Ä <div class="input-box"><input ${inputAttrs}></div></div></td><td><div class="flex-group">TOTAL <div class="input-box"><input ${inputAttrs}></div></div></td><td class="last-col"><div class="input-box"><input ${inputAttrs}></div></td></tr>
                            </table>
                        </td>
                    </tr>
                </table>
                <div class="footer-grid">
                    <div class="sig-box"><img id="sig-p-${globalSigCount}" class="display-sig" onclick="openModal('sig-p-${globalSigCount}')"><div class="sig-text">Signature du plombier</div></div>
                    <div class="sig-box"><img id="sig-c-${globalSigCount}" class="display-sig" onclick="openModal('sig-c-${globalSigCount}')"><div class="sig-text">Signature du client</div></div>
                    <div class="invoice-num-box"><input type="text" class="red-invoice-input" placeholder="No."></div>
                </div>
            </div>`;
        return page;
    }

    function addPage() { 
        containerInvoice.appendChild(createInvoicePageHTML()); 
        if(currentZoom !== 1.0) updateZoom(); 
    }
    
    // üî• NOUVELLE FONCTION DUPLIQUER INTELLIGENTE üî•
    function duplicatePage() {
        const pages = containerInvoice.querySelectorAll('.page');
        if (pages.length === 0) return;
        
        const sourcePage = pages[pages.length - 1];
        const newPage = createInvoicePageHTML();
        
        containerInvoice.appendChild(newPage);
        
        // Copie UNIQUEMENT les inputs de la zone d'en-t√™te (.top-section)
        const sourceTopInputs = sourcePage.querySelectorAll('.top-section input');
        const newTopInputs = newPage.querySelectorAll('.top-section input');
        
        sourceTopInputs.forEach((input, index) => { 
            if(newTopInputs[index]) {
                newTopInputs[index].value = input.value; 
            }
        });
        
        if(currentZoom !== 1.0) updateZoom();
    }
    
    function deletePage() { 
        if (containerInvoice.children.length > 1) { 
            containerInvoice.removeChild(containerInvoice.lastElementChild); invoicePageCount--;
        } else {
            showAlert("Impossible de supprimer la derni√®re page."); 
        }
    }
    
    function askClearInputs() { 
        showConfirm("Effacer tout le contenu de la facture ?", function() {
            containerInvoice.querySelectorAll('input').forEach(input => input.value = '');
            containerInvoice.querySelectorAll('.display-sig').forEach(img => img.src = ''); 
        });
    }

    const modal = document.getElementById('sig-modal');
    const modalCanvas = document.getElementById('modal-canvas');
    const ctx = modalCanvas.getContext('2d');
    let currentTargetImgId = null, drawing = false;

    function resizeCanvas() { 
        const ratio = Math.max(window.devicePixelRatio || 1, 1); 
        modalCanvas.width = modalCanvas.offsetWidth * ratio; 
        modalCanvas.height = modalCanvas.offsetHeight * ratio;
        ctx.scale(ratio, ratio); 
        ctx.lineWidth = 3; 
        ctx.lineCap = 'round'; 
        ctx.strokeStyle = '#000';
    }

    function openModal(id) { 
        currentTargetImgId = id; 
        modal.style.display = 'flex'; 
        setTimeout(resizeCanvas, 10);
    }
    
    function closeModal() { modal.style.display = 'none'; drawing = false; }
    function clearModalCanvas() { ctx.clearRect(0, 0, modalCanvas.width, modalCanvas.height); }
    function saveSignature() { if(currentTargetImgId) document.getElementById(currentTargetImgId).src = modalCanvas.toDataURL(); closeModal(); }
    
    function getPos(e) { 
        const rect = modalCanvas.getBoundingClientRect();
        return { x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left, y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top };
    }
    function startDrawing(e) { drawing = true; ctx.beginPath(); const pos = getPos(e); ctx.moveTo(pos.x, pos.y); if(e.type === 'touchstart') e.preventDefault(); }
    function moveDrawing(e) { if (!drawing) return; const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); if(e.type === 'touchmove') e.preventDefault(); }
    
    modalCanvas.addEventListener('mousedown', startDrawing); window.addEventListener('mousemove', moveDrawing); window.addEventListener('mouseup', () => drawing = false);
    modalCanvas.addEventListener('touchstart', startDrawing, {passive: false}); modalCanvas.addEventListener('touchmove', moveDrawing, {passive: false}); modalCanvas.addEventListener('touchend', () => drawing = false);

    /* MOTEUR ZOOM & PANORAMIQUE (TOUJOURS ACTIF) */
    let currentZoom = 1.0;
    const minZoom = 0.5, maxZoom = 3.0, zoomDisplay = document.getElementById('zoom-level');
    function updateZoom() { 
        if (currentZoom < minZoom) currentZoom = minZoom;
        if (currentZoom > maxZoom) currentZoom = maxZoom; 
        containerInvoice.style.transform = `scale(${currentZoom})`; 
        zoomDisplay.textContent = Math.round(currentZoom * 100) + '%';
        if(currentZoom > 1) { 
            containerInvoice.style.marginBottom = (currentZoom * 400) + "px"; 
            containerInvoice.style.marginTop = ((currentZoom - 1) * 100) + "px";
        } else { 
            containerInvoice.style.marginBottom = "100px"; 
            containerInvoice.style.marginTop = "0px"; 
        } 
    }
    function adjustZoom(delta) { currentZoom += delta; currentZoom = Math.round(currentZoom * 10) / 10; updateZoom(); }
    function resetZoom() { currentZoom = 1.0; updateZoom(); }
    
    let initialDistance = 0, initialZoomState = 1.0;
    const scrollArea = document.querySelector('.scroll-area');
    scrollArea.addEventListener('touchstart', function(e) { if (e.touches.length === 2) { initialDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); initialZoomState = currentZoom; } }, { passive: false });
    scrollArea.addEventListener('touchmove', function(e) { if (e.touches.length === 2) { e.preventDefault(); const currentDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); if (initialDistance > 0) { const diff = currentDistance / initialDistance; currentZoom = initialZoomState * diff; updateZoom(); } } }, { passive: false });
    scrollArea.addEventListener('wheel', function(e) { if (e.ctrlKey) { e.preventDefault(); adjustZoom(e.deltaY < 0 ? 0.1 : -0.1); } }, { passive: false });
    
    document.addEventListener('input', function(e) {
        const input = e.target; if (input.tagName !== 'INPUT') return;
        const td = input.closest('td'); if(!td) return;
        const tr = td.parentElement; const table = tr.closest('.main-table');
        if (!table || td.cellIndex !== 1) return;
        if (input.scrollWidth > input.clientWidth) {
            let val = input.value; let lastSpace = val.lastIndexOf(' ');
            if (lastSpace !== -1) {
                let wordToMove = val.substring(lastSpace + 1); let textToKeep = val.substring(0, lastSpace);
                if(wordToMove.length === 0) return;
                input.value = textToKeep;
                let nextTr = tr.nextElementSibling;
                if (nextTr) { let nextTd = nextTr.children[1]; if (nextTd) { let nextInput = nextTd.querySelector('input'); if (nextInput) { let newText = nextInput.value.length > 0 ? wordToMove + " " + nextInput.value : wordToMove; nextInput.value = newText; nextInput.focus(); nextInput.setSelectionRange(wordToMove.length, wordToMove.length); } } }
            }
        }
    });
    
    document.addEventListener('keydown', function(e) {
        const input = e.target; if (input.tagName !== 'INPUT') return;
        if (e.key === 'Enter') {
            e.preventDefault(); const currentTd = input.closest('td'); const currentTr = input.closest('tr');
            if (currentTr && currentTd) { const cellIndex = currentTd.cellIndex; const nextTr = currentTr.nextElementSibling; if (nextTr) { const nextTd = nextTr.children[cellIndex]; if (nextTd) { const nextInput = nextTd.querySelector('input'); if (nextInput) { nextInput.focus(); return; } } } }
             const allInputs = Array.from(document.querySelectorAll('input')); const index = allInputs.indexOf(input); if (index > -1 && index < allInputs.length - 1) allInputs[index + 1].focus();
        }
        if (e.key === 'Backspace') {
            if (input.selectionStart === 0 && input.selectionEnd === 0) {
                const currentTd = input.closest('td'); const currentTr = input.closest('tr');
                if (currentTr && currentTd) { const cellIndex = currentTd.cellIndex;
                const prevTr = currentTr.previousElementSibling; if (prevTr) { const prevTd = prevTr.children[cellIndex]; if (prevTd) { const prevInput = prevTd.querySelector('input');
                if (prevInput) { e.preventDefault(); prevInput.focus(); const len = prevInput.value.length; prevInput.setSelectionRange(len, len);
                } } } }
            }
        }
    });
    
    loadData();
</script>
</body>
</html>
